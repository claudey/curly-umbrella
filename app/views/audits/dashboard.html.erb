<% content_for :title, "Audit Dashboard" %>

<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div class="bg-white shadow">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">
            <i class="ph-shield-check text-blue-600 mr-2"></i>
            Audit Dashboard
          </h1>
          <p class="text-gray-600 mt-1">
            System activity monitoring and compliance reporting
          </p>
        </div>
        
        <!-- Date Range Filter -->
        <div class="flex items-center space-x-4">
          <%= form_with url: dashboard_audits_path, method: :get, local: true, class: "flex items-center space-x-2" do |f| %>
            <%= f.date_field :start_date, value: @date_range[:start], 
                            class: "rounded-md border-gray-300 text-sm" %>
            <span class="text-gray-500">to</span>
            <%= f.date_field :end_date, value: @date_range[:end], 
                            class: "rounded-md border-gray-300 text-sm" %>
            <%= f.submit "Update", class: "btn-primary text-sm" %>
          <% end %>
          
          <!-- Export Dropdown -->
          <div class="relative" data-controller="dropdown">
            <button data-action="click->dropdown#toggle" 
                    class="btn-secondary text-sm flex items-center">
              <i class="ph-download mr-2"></i>
              Export
              <i class="ph-caret-down ml-1"></i>
            </button>
            
            <div data-dropdown-target="menu" 
                 class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 hidden z-50">
              <div class="py-1">
                <%= link_to export_audits_path(format: 'csv', start_date: @date_range[:start], end_date: @date_range[:end]),
                           class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" do %>
                  <i class="ph-file-csv mr-2"></i>Export as CSV
                <% end %>
                <%= link_to export_audits_path(format: 'pdf', start_date: @date_range[:start], end_date: @date_range[:end]),
                           class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" do %>
                  <i class="ph-file-pdf mr-2"></i>Export as PDF
                <% end %>
                <%= link_to compliance_report_audits_path(format: 'pdf', start_date: @date_range[:start], end_date: @date_range[:end]),
                           class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" do %>
                  <i class="ph-certificate mr-2"></i>Compliance Report
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="px-6 py-6">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-blue-100">
            <i class="ph-activity text-blue-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Total Activities</p>
            <p class="text-2xl font-semibold text-gray-900">
              <%= number_with_delimiter(@stats[:total_activities]) %>
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-yellow-100">
            <i class="ph-warning text-yellow-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Suspicious Activities</p>
            <p class="text-2xl font-semibold text-gray-900">
              <%= @stats[:by_severity]['warning'].to_i + @stats[:by_severity]['error'].to_i + @stats[:by_severity]['critical'].to_i %>
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-green-100">
            <i class="ph-database text-green-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Data Modifications</p>
            <p class="text-2xl font-semibold text-gray-900">
              <%= @stats[:by_category]['data_modification'] || 0 %>
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-purple-100">
            <i class="ph-shield-check text-purple-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Compliance Events</p>
            <p class="text-2xl font-semibold text-gray-900">
              <%= @stats[:by_category]['compliance'] || 0 %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Activity Chart -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          <i class="ph-chart-line mr-2"></i>
          Daily Activity Trend
        </h3>
        <div id="activity-chart" class="h-64"></div>
      </div>

      <!-- Categories Breakdown -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          <i class="ph-chart-pie mr-2"></i>
          Activity by Category
        </h3>
        <div id="category-chart" class="h-64"></div>
      </div>
    </div>

    <!-- Tables Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Top Users -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="ph-users mr-2"></i>
            Most Active Users
          </h3>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <% @stats[:by_user].sort_by { |k, v| -v }.first(5).each do |user_name, count| %>
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                    <i class="ph-user text-gray-600"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">
                      <%= user_name.is_a?(Array) ? user_name.join(' ') : user_name %>
                    </p>
                  </div>
                </div>
                <span class="text-sm text-gray-500">
                  <%= pluralize(count, 'activity') %>
                </span>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Recent Critical Activities -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="ph-warning-circle mr-2"></i>
            Recent Critical Activities
          </h3>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <% @recent_activities.each do |activity| %>
              <div class="border-l-4 pl-4 <%= severity_border_class(activity.severity) %>">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-900">
                      <%= activity.display_action %>
                    </p>
                    <p class="text-xs text-gray-500">
                      <%= activity.user&.display_name || 'System' %> • 
                      <%= time_ago_in_words(activity.created_at) %> ago
                    </p>
                  </div>
                  <span class="text-xs px-2 py-1 rounded-full <%= severity_badge_class(activity.severity) %>">
                    <%= activity.display_severity %>
                  </span>
                </div>
              </div>
            <% end %>
            
            <% if @recent_activities.empty? %>
              <div class="text-center py-4">
                <i class="ph-check-circle text-green-500 text-3xl mb-2"></i>
                <p class="text-gray-500">No critical activities in the selected period</p>
              </div>
            <% end %>
          </div>
          
          <div class="mt-4 pt-4 border-t border-gray-200">
            <%= link_to audits_path, class: "text-sm text-blue-600 hover:text-blue-800 font-medium" do %>
              View all audit logs →
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Integration -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Activity Trend Chart
const activityCtx = document.getElementById('activity-chart').getContext('2d');
const activityChart = new Chart(activityCtx, {
  type: 'line',
  data: {
    labels: <%= raw @stats[:daily_activity].keys.to_json %>,
    datasets: [{
      label: 'Daily Activities',
      data: <%= raw @stats[:daily_activity].values.to_json %>,
      borderColor: 'rgb(59, 130, 246)',
      backgroundColor: 'rgba(59, 130, 246, 0.1)',
      tension: 0.1,
      fill: true
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true
      }
    },
    plugins: {
      legend: {
        display: false
      }
    }
  }
});

// Category Pie Chart
const categoryCtx = document.getElementById('category-chart').getContext('2d');
const categoryChart = new Chart(categoryCtx, {
  type: 'doughnut',
  data: {
    labels: <%= raw @stats[:by_category].keys.map(&:humanize).to_json %>,
    datasets: [{
      data: <%= raw @stats[:by_category].values.to_json %>,
      backgroundColor: [
        '#3B82F6', // Blue
        '#10B981', // Green
        '#F59E0B', // Yellow
        '#EF4444', // Red
        '#8B5CF6', // Purple
        '#06B6D4', // Cyan
        '#84CC16', // Lime
        '#F97316', // Orange
        '#EC4899'  // Pink
      ]
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom'
      }
    }
  }
});
</script>