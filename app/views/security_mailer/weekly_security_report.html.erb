<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ“ˆ Weekly Security Report</title>
  <style>
    .container { max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif; }
    .header { background: #1f2937; color: white; padding: 25px; text-align: center; }
    .content { padding: 25px; background: #fff; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 25px 0; }
    .summary-card { background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .card-header { font-size: 14px; color: #6b7280; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; }
    .card-value { font-size: 28px; font-weight: bold; color: #1f2937; margin-bottom: 5px; }
    .card-change { font-size: 12px; }
    .trend-up { color: #dc2626; }
    .trend-down { color: #10b981; }
    .section { margin: 30px 0; }
    .chart-placeholder { background: #f3f4f6; padding: 40px; text-align: center; border-radius: 8px; color: #6b7280; }
    .alert-list { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; }
    .alert-item { padding: 15px; border-bottom: 1px solid #e5e7eb; }
    .alert-item:last-child { border-bottom: none; }
    .severity-critical { border-left: 4px solid #dc2626; }
    .severity-high { border-left: 4px solid #f59e0b; }
    .severity-medium { border-left: 4px solid #3b82f6; }
    .severity-low { border-left: 4px solid #10b981; }
    .footer { background: #f3f4f6; padding: 20px; text-align: center; font-size: 12px; color: #6b7280; }
    .button { display: inline-block; background: #1f2937; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ“ˆ Weekly Security Report</h1>
      <p><%= @start_date.strftime("%B %d") %> - <%= @end_date.strftime("%B %d, %Y") %></p>
      <p><%= @organization.name %></p>
    </div>
    
    <div class="content">
      <p>Hello <%= @admin.first_name %>,</p>
      
      <p>Here's your comprehensive security report for the week of <%= @start_date.strftime("%B %d") %> to <%= @end_date.strftime("%B %d, %Y") %>.</p>
      
      <div class="summary-grid">
        <div class="summary-card">
          <div class="card-header">Total Alerts</div>
          <div class="card-value"><%= @summary[:total_alerts] %></div>
        </div>
        
        <div class="summary-card">
          <div class="card-header">Critical Alerts</div>
          <div class="card-value" style="color: #dc2626;"><%= @summary[:by_severity]['critical'] || 0 %></div>
        </div>
        
        <div class="summary-card">
          <div class="card-header">High Priority</div>
          <div class="card-value" style="color: #f59e0b;"><%= @summary[:by_severity]['high'] || 0 %></div>
        </div>
        
        <div class="summary-card">
          <div class="card-header">Resolution Rate</div>
          <div class="card-value" style="color: #10b981;">
            <%= @summary[:total_alerts] > 0 ? ((@summary[:resolved_count].to_f / @summary[:total_alerts]) * 100).round(1) : 0 %>%
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>Alert Distribution by Type</h3>
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
          <% if @summary[:by_type].any? %>
            <% @summary[:by_type].each do |type, count| %>
              <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                <span><%= type.humanize %></span>
                <span style="font-weight: bold;"><%= count %></span>
              </div>
            <% end %>
          <% else %>
            <p style="text-align: center; color: #6b7280;">No alerts this week</p>
          <% end %>
        </div>
      </div>
      
      <div class="section">
        <h3>Top Priority Alerts</h3>
        <% if @top_alerts.any? %>
          <div class="alert-list">
            <% @top_alerts.each do |alert| %>
              <div class="alert-item severity-<%= alert.severity %>">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <h4 style="margin: 0 0 5px 0; color: #1f2937;"><%= alert.alert_type.humanize %></h4>
                    <p style="margin: 0 0 5px 0; font-size: 14px; color: #4b5563;"><%= alert.message %></p>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">
                      <%= alert.triggered_at.strftime("%B %d at %I:%M %p") %>
                    </p>
                  </div>
                  <div style="text-align: right;">
                    <span style="font-size: 11px; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; font-weight: bold; background: <%= alert.severity == 'critical' ? '#fef2f2' : '#fef3cd' %>; color: <%= alert.severity == 'critical' ? '#dc2626' : '#f59e0b' %>;">
                      <%= alert.severity %>
                    </span>
                    <br>
                    <span style="font-size: 11px; padding: 4px 8px; border-radius: 12px; margin-top: 5px; display: inline-block; background: <%= alert.status == 'resolved' ? '#dcfce7' : '#fef3cd' %>; color: <%= alert.status == 'resolved' ? '#166534' : '#92400e' %>;">
                      <%= alert.status.humanize %>
                    </span>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
            <h4>ðŸŽ‰ No High Priority Alerts</h4>
            <p style="color: #6b7280;">Your organization had no critical or high priority security alerts this week.</p>
          </div>
        <% end %>
      </div>
      
      <div class="section">
        <h3>Security Recommendations</h3>
        <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
          <ul style="margin: 0; padding-left: 20px;">
            <% if @summary[:total_alerts] == 0 %>
              <li>Great job! No security incidents this week. Continue monitoring and maintaining security best practices.</li>
            <% else %>
              <% if @summary[:unresolved_count] > 0 %>
                <li><strong>Action Required:</strong> You have <%= @summary[:unresolved_count] %> unresolved security alert<%= @summary[:unresolved_count] > 1 ? 's' : '' %>. Please review and address these immediately.</li>
              <% end %>
              <% if (@summary[:by_severity]['critical'] || 0) > 0 %>
                <li><strong>Critical Alert Follow-up:</strong> Ensure all critical alerts have been properly investigated and resolved.</li>
              <% end %>
              <li>Review your security dashboard regularly to stay ahead of potential threats.</li>
              <li>Consider implementing additional security measures if you're seeing repeated alert types.</li>
            <% end %>
            <li>Schedule a security review meeting if you have questions about any alerts.</li>
          </ul>
        </div>
      </div>
      
      <div style="text-align: center; margin: 30px 0;">
        <a href="<%= admin_security_dashboard_index_url %>" class="button">View Security Dashboard</a>
        <a href="<%= admin_security_dashboard_alerts_url %>" class="button" style="margin-left: 10px;">Review All Alerts</a>
      </div>
    </div>
    
    <div class="footer">
      <p>Report Period: <%= @start_date.strftime("%B %d, %Y") %> - <%= @end_date.strftime("%B %d, %Y") %></p>
      <p>BrokerSync Security Team â€¢ Automated Weekly Report</p>
      <p>For questions about this report, contact your system administrator.</p>
    </div>
  </div>
</body>
</html>