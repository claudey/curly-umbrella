<% content_for :title, "Application Distribution Management" %>

<div class="container mx-auto p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Distribution Management</h1>
      <p class="text-gray-600 mt-1">Manage application distribution to insurance companies</p>
    </div>
    
    <div class="flex gap-3">
      <%= link_to admin_distributions_path(format: :csv), 
                  class: "btn btn-outline btn-sm" do %>
        <i class="ph ph-download-simple w-4 h-4"></i>
        Export
      <% end %>
      
      <%= link_to auto_distribute_pending_admin_distributions_path, 
                  method: :post,
                  class: "btn btn-primary btn-sm",
                  data: { confirm: "This will auto-distribute all pending applications. Continue?" } do %>
        <i class="ph ph-lightning w-4 h-4"></i>
        Auto-Distribute Pending
      <% end %>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-figure text-primary">
        <i class="ph ph-files text-3xl"></i>
      </div>
      <div class="stat-title">Total Applications</div>
      <div class="stat-value text-primary"><%= @summary_stats[:total_applications] %></div>
      <div class="stat-desc">
        <span class="text-success">
          <%= @summary_stats[:distributed_applications] %> distributed
        </span>
      </div>
    </div>

    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-figure text-warning">
        <i class="ph ph-clock text-3xl"></i>
      </div>
      <div class="stat-title">Pending Distribution</div>
      <div class="stat-value text-warning"><%= @summary_stats[:pending_distribution] %></div>
      <div class="stat-desc">Awaiting distribution</div>
    </div>

    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-figure text-info">
        <i class="ph ph-share-network text-3xl"></i>
      </div>
      <div class="stat-title">Total Distributions</div>
      <div class="stat-value text-info"><%= @summary_stats[:total_distributions] %></div>
      <div class="stat-desc">
        <%= @summary_stats[:responded_distributions] %> responded
      </div>
    </div>

    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-figure text-secondary">
        <i class="ph ph-timer text-3xl"></i>
      </div>
      <div class="stat-title">Avg Response Time</div>
      <div class="stat-value text-secondary"><%= @summary_stats[:avg_response_time] %>h</div>
      <div class="stat-desc">
        <%= @summary_stats[:companies_with_pending] %> companies pending
      </div>
    </div>
  </div>

  <!-- Filters -->
  <%= form_with url: admin_distributions_path, method: :get, local: true, class: "mb-6" do |f| %>
    <div class="bg-base-100 rounded-lg shadow p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
        <div>
          <%= f.select :status, 
                      options_for_select([
                        ['All Statuses', ''],
                        ['Draft', 'draft'],
                        ['Submitted', 'submitted'],
                        ['Under Review', 'under_review'],
                        ['Approved', 'approved'],
                        ['Rejected', 'rejected']
                      ], @filter_params[:status]), 
                      {}, 
                      { class: "select select-bordered w-full" } %>
        </div>
        
        <div>
          <%= f.select :insurance_type,
                      options_for_select([
                        ['All Types', ''],
                        ['Fire Insurance', 'fire'],
                        ['Motor Insurance', 'motor'],
                        ['Liability Insurance', 'liability'],
                        ['General Accident', 'general_accident'],
                        ['Bonds Insurance', 'bonds']
                      ], @filter_params[:insurance_type]),
                      {},
                      { class: "select select-bordered w-full" } %>
        </div>
        
        <div>
          <%= f.select :distribution_status,
                      options_for_select([
                        ['All Distribution Status', ''],
                        ['Distributed', 'distributed'],
                        ['Pending Distribution', 'pending_distribution'],
                        ['No Responses', 'no_responses']
                      ], @filter_params[:distribution_status]),
                      {},
                      { class: "select select-bordered w-full" } %>
        </div>
        
        <div>
          <%= f.select :sort,
                      options_for_select([
                        ['Newest First', 'created_desc'],
                        ['Oldest First', 'created_asc'],
                        ['Recently Distributed', 'distributed_desc'],
                        ['By Status', 'status']
                      ], @filter_params[:sort]),
                      {},
                      { class: "select select-bordered w-full" } %>
        </div>
        
        <div>
          <%= f.text_field :search, 
                          placeholder: "Search applications...", 
                          value: @filter_params[:search],
                          class: "input input-bordered w-full" %>
        </div>
        
        <div class="flex gap-2">
          <%= f.submit "Filter", class: "btn btn-primary" %>
          <%= link_to "Clear", admin_distributions_path, class: "btn btn-ghost" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Bulk Actions -->
  <%= form_with url: bulk_actions_admin_distributions_path, method: :post, local: true, id: "bulk-form" do |f| %>
    <div class="bg-base-100 rounded-lg shadow mb-6">
      <div class="p-4 border-b">
        <div class="flex items-center gap-4">
          <label class="cursor-pointer label">
            <input type="checkbox" id="select-all" class="checkbox checkbox-primary">
            <span class="label-text ml-2">Select All</span>
          </label>
          
          <div class="flex gap-2" id="bulk-actions" style="display: none;">
            <%= f.select :bulk_action, 
                        options_for_select([
                          ['Choose Action', ''],
                          ['Redistribute', 'redistribute'],
                          ['Expire Distributions', 'expire'],
                          ['Send Reminders', 'send_reminders']
                        ]),
                        {},
                        { class: "select select-bordered select-sm" } %>
            <%= f.submit "Apply", class: "btn btn-sm btn-primary" %>
          </div>
        </div>
      </div>
    </div>
    <%= f.hidden_field :selected_ids, id: "selected-ids" %>
  <% end %>

  <!-- Applications Table -->
  <div class="bg-base-100 rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr>
            <th>
              <input type="checkbox" class="checkbox checkbox-primary" id="header-select-all">
            </th>
            <th>Application #</th>
            <th>Client</th>
            <th>Type</th>
            <th>Status</th>
            <th>Distribution Status</th>
            <th>Companies</th>
            <th>Response Rate</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @applications.each do |application| %>
            <tr>
              <td>
                <input type="checkbox" class="checkbox checkbox-primary row-select" 
                       value="<%= application.id %>">
              </td>
              <td>
                <%= link_to application.application_number, 
                           admin_distribution_path(application),
                           class: "font-medium text-primary hover:underline" %>
              </td>
              <td>
                <div class="flex items-center gap-3">
                  <div class="avatar placeholder">
                    <div class="bg-neutral-focus text-neutral-content rounded-full w-8">
                      <span class="text-xs"><%= application.client.initials %></span>
                    </div>
                  </div>
                  <div>
                    <div class="font-bold"><%= application.client.full_name %></div>
                    <div class="text-sm opacity-50"><%= application.client.email %></div>
                  </div>
                </div>
              </td>
              <td>
                <div class="badge badge-outline">
                  <%= application.insurance_type_display_name %>
                </div>
              </td>
              <td>
                <div class="badge <%= application.status_badge_class %>">
                  <i class="<%= application.status_icon %> w-3 h-3 mr-1"></i>
                  <%= application.status.humanize %>
                </div>
              </td>
              <td>
                <% if application.distributed? %>
                  <div class="badge badge-success">Distributed</div>
                  <div class="text-xs text-gray-500">
                    <%= time_ago_in_words(application.distributed_at) %> ago
                  </div>
                <% else %>
                  <div class="badge badge-warning">Pending</div>
                <% end %>
              </td>
              <td>
                <div class="text-sm">
                  <%= application.application_distributions.count %> companies
                </div>
                <% if application.distributed? %>
                  <div class="text-xs text-gray-500">
                    <%= application.application_distributions.where.not(status: 'pending').count %> responded
                  </div>
                <% end %>
              </td>
              <td>
                <% if application.application_distributions.any? %>
                  <% total = application.application_distributions.count %>
                  <% responded = application.application_distributions.where.not(status: 'pending').count %>
                  <% rate = total > 0 ? (responded.to_f / total * 100).round(1) : 0 %>
                  
                  <div class="radial-progress text-primary" 
                       style="--value:<%= rate %>; --size:2rem;" 
                       role="progressbar">
                    <span class="text-xs"><%= rate.to_i %>%</span>
                  </div>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <td>
                <div class="text-sm"><%= application.created_at.strftime('%b %d, %Y') %></div>
                <div class="text-xs text-gray-500"><%= application.created_at.strftime('%I:%M %p') %></div>
              </td>
              <td>
                <div class="dropdown dropdown-end">
                  <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                    <i class="ph ph-dots-three-vertical"></i>
                  </div>
                  <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li>
                      <%= link_to admin_distribution_path(application) do %>
                        <i class="ph ph-eye"></i> View Details
                      <% end %>
                    </li>
                    <% if application.can_be_distributed? %>
                      <li>
                        <%= link_to redistribute_admin_distribution_path(application), 
                                   method: :post do %>
                          <i class="ph ph-share-network"></i> Distribute Now
                        <% end %>
                      </li>
                    <% end %>
                    <% if application.distributed? %>
                      <li>
                        <%= link_to redistribute_admin_distribution_path(application) do %>
                          <i class="ph ph-arrow-clockwise"></i> Redistribute
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    
    <% if @applications.empty? %>
      <div class="p-8 text-center text-gray-500">
        <i class="ph ph-files text-4xl mb-4"></i>
        <p class="text-lg font-medium">No applications found</p>
        <p>Try adjusting your search criteria or filters</p>
      </div>
    <% end %>
  </div>

  <!-- Recent Distributions -->
  <div class="mt-8">
    <h2 class="text-xl font-bold mb-4">Recent Distribution Activity</h2>
    <div class="bg-base-100 rounded-lg shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Application</th>
              <th>Company</th>
              <th>Match Score</th>
              <th>Status</th>
              <th>Distributed</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_distributions.each do |distribution| %>
              <tr>
                <td>
                  <%= link_to distribution.insurance_application.application_number,
                             admin_distribution_path(distribution.insurance_application),
                             class: "font-medium text-primary hover:underline" %>
                </td>
                <td><%= distribution.insurance_company.name %></td>
                <td>
                  <div class="flex items-center gap-2">
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                      <div class="bg-primary h-2 rounded-full" 
                           style="width: <%= distribution.match_score %>%"></div>
                    </div>
                    <span class="text-sm font-medium"><%= distribution.match_score %>%</span>
                  </div>
                </td>
                <td>
                  <div class="badge <%= distribution.status_badge_class %>">
                    <%= distribution.status.humanize %>
                  </div>
                </td>
                <td>
                  <div class="text-sm"><%= time_ago_in_words(distribution.created_at) %> ago</div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // Bulk selection functionality
  const selectAllCheckbox = document.getElementById('select-all');
  const headerSelectAllCheckbox = document.getElementById('header-select-all');
  const rowSelects = document.querySelectorAll('.row-select');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedIds = document.getElementById('selected-ids');

  function updateBulkActions() {
    const selectedCount = document.querySelectorAll('.row-select:checked').length;
    if (selectedCount > 0) {
      bulkActions.style.display = 'flex';
      const ids = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
      selectedIds.value = ids.join(',');
    } else {
      bulkActions.style.display = 'none';
      selectedIds.value = '';
    }
  }

  [selectAllCheckbox, headerSelectAllCheckbox].forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const isChecked = this.checked;
      rowSelects.forEach(cb => cb.checked = isChecked);
      // Update the other select-all checkbox
      if (this === selectAllCheckbox) {
        headerSelectAllCheckbox.checked = isChecked;
      } else {
        selectAllCheckbox.checked = isChecked;
      }
      updateBulkActions();
    });
  });

  rowSelects.forEach(cb => {
    cb.addEventListener('change', function() {
      const allChecked = Array.from(rowSelects).every(cb => cb.checked);
      const noneChecked = Array.from(rowSelects).every(cb => !cb.checked);
      
      selectAllCheckbox.checked = allChecked;
      headerSelectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
      headerSelectAllCheckbox.indeterminate = !allChecked && !noneChecked;
      
      updateBulkActions();
    });
  });
</script>
